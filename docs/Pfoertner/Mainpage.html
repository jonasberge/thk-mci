<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Porter Mainpage</title>
    <link rel="stylesheet" href="../vendor/bulma-0.9.0/bulma.min.css">
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>

<!--hero---------------------------------------------------------------------------------->
  <section class="hero mx-0">
    <div class="hero-image">
      <div class="hero-text">
        <h1 class="title is-1 has-text-white mx-4 my-2">
          TH-Köln
        </h1>
        <h2 class="subtitle is-2 has-text-white mx-4 my-2">
          Campus Gummersbach
        </h2>
        <!-- Main container -->
        <nav class="level">
          <!-- Left side -->
          <div class="level-left">
          </div>
          <!-- Right side -->
          <div class="level-right mr-4 mb-2">
            <div class="level-item">
              <div class="field has-addons">
                <p class="control">
                  <input class="input" type="text" placeholder="Suche">
                </p>
                <p class="control">
                  <button class="button">
                    Suchen
                  </button>
                </p>
              </div>
          </div>
        </nav>
      </div>
    </div>
  </section>


<!--nav----------------------------------------------------------------------------------->
  <!--nav class="navbar is-primary">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item" href="#" style="font-weight: bold;">
          Trans.ponder
        </a>
        <span class="navbar-burger burger" data-target="navMenu">
          <span></span>
          <span></span>
          <span></span>
        </span>
      </div>
      <div id="navMenu" class="navbar-menu">
        <div class="navbar-end">
          <a href="#" class="navbar-item is-activ">Home</a>
          <a href="#" class="navbar-item">Verleih</a>
          <a href="#" class="navbar-item">Rückgabe</a>
          <a href="#" class="navbar-item">Verliehene</a>
          <a href="#" class="navbar-item">Suche</a>
        </div>
      </div>
    </div>
  </nav>
  <script type="text/javascript">
    (function(){
      var burger = document.querySelector('.burger');
      var nav = document.querySelector('#'+burger.dataset.target);

      burger.addEventListener('click', function(){
        burger.classList.toggle('is-active');
        nav.classList.toggle('is-active');
      });
    })();
  </script-->

<!--sidemenu------------------------------------------------------------------------------>
<div class="columns is-fullheight">
  <div class="column is-2 is-sidebar-menu is-hidden-mobile is-fullheight">
    <aside class="menu">
      <hr class="navbar-divider">
      <p class="menu-label">
        Dashboard
      </p>
      <hr class="navbar-divider">
      <ul class="menu-list">
        <li><a class="is-active">Dashboard</a></li>
        <li id="btn_trans_verleih"><a>Verleih</a></li>
        <li id="btn_trans_rückgabe"><a>Rückgabe</a></li>
        <li><a class="has-text-grey">Verliehene Transponder
        </a></li>
      </ul>
      <div>
        <hr class="navbar-divider">
        <p class="menu-label">
          Sonstige
        </p>
        <hr class="navbar-divider">
        <ul class="menu-list">
          <li><a class="has-text-grey">Einstellung</a></li>
          <li><a href="./Login.html">Logout</a></li>
        </ul>
      </div>

    </aside>
  </div>

<!--Modal-scheme------------------------------------------
  <section>
    <div>
      <button class="button is-link is-large" id="button-modal">Link</button>

      <div class="modal" id="page-modal">
        <div class="modal-background"></div>
        <div class="modal-content">
          Hier ist ein PopUp
        </div>
        <button class="modal-close is-large" aria-label="close" id="button-close"></button>
      </div>
    </div>
    <script type="text/javascript">
      var button_modal = document.getElementById('button-modal')
      var modal = document.getElementById('page-modal')
      var button_close = document.getElementById('button-close')

      button_modal.onclick = function(){
        modal.style.display = 'block';
      }
      button_close.onclick = function(){
        modal.style.display = 'none'
      }
    </script>
  </section>
-->


    <!--Transponder zurückgeben------------------>
  <section>
    <div>
      <div class="modal pt-6" id="mdl_trans_rückgabe">
        <div class="modal-background"></div>
        <div class="modal-content mt-6">
          <article class="message is-large is-link">
            <div class="message-header">
              <p>Transponder zurückgeben</p>
            </div>
            <div class="message-body">
              <section class="container">
                <div class="level ">
                  <p class="level-item"><input id="input-transponder-number" class="input is-clipped" type="text" placeholder="Transpondernummer eingeben..."></p>
                  <p class="level-item"><button class="button is-link" id="btn_trans_rückgabe_prüfen">Prüfen</button></p>
                </div>
                <br>
                <div class="level" id="container-lending-info">
                  <div class="level-item">
                    <p>
                      <span class="info-title-room">Raum</span>:<br>
                      Ausleiher:<br>
                      Ausleihdatum:<br>
                      Uhrzeit:<br>
                      Fristgerecht:
                    </p>
                  </div>
                  <div class="level-item">
                    <p>
                      <span class="info-room"></span><br> <!-- 0.401 -->
                      <span class="info-lender"></span><br> <!-- Alex Brimm -->
                      <span class="info-lending-time"></span><br> <!-- TT.MM.YYYY -->
                      <span class="info-current-time"></span><br> <!-- HH:MM Uhr -->
                      <span class="info-on-time"></span> <!-- Ja -->
                    </p>
                  </div>
                </div>
                <br>
                <div class="level" id="btn_close_trans_rückgabe">
                  <button class="button is-link is-outlined ">Abbrechen</button>
                  &nbsp;&nbsp;&nbsp;&nbsp;
                  <button class="button is-link level-item">Rückgabe Bestätigen</button>
                </div>
              </section>
            </div>
          </article>
        </div>
      </div>
    </div>
  </section>

  <!--Transponder verleihen-------------------->
  <section>
    <div>
      <div class="modal pt-6" id="mdl_trans_verleih">
        <div class="modal-background"></div>
        <div class="modal-content mt-6">
          <article class="message is-large is-link">
            <div class="message-header">
              <p>Transponder verleihen</p>
            </div>
            <div class="message-body">
              <section class="container">
                <div class="section py-0">
                  Geben Sie eine Raumnummer ein und wählen Sie einen Transponder.<br><br>Raum: <input class="input" placeholder="0.000"><br>
                </div>
                <section class="section pb-0 pt-4">
                  <div class="columns">
                    <div class="column is-three-fifth">
                      <div class="control">
                        <div class="select">
                          <select>
                            <option>Transponder wählen...</option>
                            <option>Transponder 1</option>
                            <option>Transponder 2</option>
                            <option>Transponder 3</option>
                            <option>Transponder 4</option>
                            <option>Transponder 5</option>
                          </select>
                        </div>
                      </div>
                    </div>

                    <div class="column is-two-fifth">
                      <div class="level">
                        <button class="button is-link level-item">MultiCa prüfen</button>
                      </div>
                    </div>
                  </div>

                  <section class="section py-0 px-0">
                    <div class="level">
                      <button class="button is-link level-item">Unterschrift einlesen</button>
                    </div>
                    <div class="level">
                      <div class="left-level"></div>
                      <div class="right-level">
                        <section class="section level-item pb-0 pr-0" id="btn_close_trans_verleih">
                          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                          <button class="button is-link is-outlined is-medium">Abbrechen</button>
                          &nbsp;
                          <button class="button is-link is-medium">Bestätigen</button>
                        </section>
                      </div>
                    </div>
                  </section>
                </section>
              </section>
            </div>
          </article>
        </div>
      </div>
    </div>
    <script type="text/javascript">
      //Modal itself
      var button_modal_transponder_verleih = document.getElementById('btn_trans_verleih')
      var modal_transponder_verleih = document.getElementById('mdl_trans_verleih')
      var button_close_transponder_verleih = document.getElementById('btn_close_trans_verleih')

      button_modal_transponder_verleih.onclick = function(){
        modal_transponder_verleih.style.display = 'block';
      }
      button_close_transponder_verleih.onclick = function(){
        modal_transponder_verleih.style.display = 'none';
      }
    </script>
  </section>


  <!--table------------------------------------------------------------------------------>
  <div class="column" >
    <div class="table-container">
      <table id="table-transponder" class="table is-hoverable is-fullwidth">
        <thead class="is-primary">
          <tr>
            <td>Raum</td><td>Dozent</td><td>Transponderliste</td><td>Dauer</td><td>Status</td><td>Icon</td>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>



<script src="../vendor/sql-js/sql-wasm.js"></script>
<script src="../assets/scripts/util.js"></script>
<script src="../assets/scripts/db.js"></script>
<script src="../assets/scripts/queries.js"></script>
<script> // load all transponders into the table

const load_transponders = (function () {

  const table = document.querySelector('#table-transponder');

  const create_td_with = function (value) {
    const td = document.createElement('td');
    td.innerText = value;
    return td;
  };

  const formatSeconds = function (s) {
    result = '';
    if (!s)
      return result;

    t = secondsToTime(s);

    if (t.h > 0)
      result += t.h + ' Stunde' + (t.h == 1 ? '' : 'n');

    if (t.m > 0) {
      if (t.h > 0)
        result += ' und';
      result += ' ' + t.m + ' Minute' + (t.m == 1 ? '' : 'n');
    }

    result += t.s;

    return result;
  }

  let last_timeout = null;

  return function () {

    if (last_timeout)
      clearTimeout(last_timeout);

    return new Promise(function (resolve, reject) {

      return query_transponders().then(function (result) {
        tds = [];

        while (table.firstChild)
          table.removeChild(table.firstChild);

        for (room of result) {
          const rental_time = formatSeconds(room.diff_seconds);

          const tr = document.createElement('tr');
          const items = {
            room_name: room.room_name,
            responsible_professor: room.responsible_professor,
            transponder_list: room.transponder_list,
            rental_time: rental_time,
            is_rented: room.is_rented ? 'Rot' : 'Grün',
            icon: '<icon>'
          }

          for (key in items) {
            if (items.hasOwnProperty(key)) {
              const td = document.createElement('td');
              td.innerText = items[key];
              tr.appendChild(td);
              if (key == 'rental_time') {
                td.dataset.seconds = room.diff_seconds;
                tds.push(td);
              }
            }
          }

          table.appendChild(tr);
        }

        const timeout_seconds = 1;
        const timeout_function = function () {
          for (td of tds) {
            seconds = parseInt(td.dataset.seconds) + timeout_seconds;
            td.innerText = formatSeconds(seconds);
            td.dataset.seconds = seconds;
          }
        };

        (function create_timeout() {
          last_timeout = setTimeout(function () {
            timeout_function();
            create_timeout();
          }, timeout_seconds * 1000);
        })();

        resolve();

      }, reject);

    });

  };

})();

const load_transponders_errorFunc = function (reason) {
  console.error('Could not load transponders', reason);
};

load_transponders().then(function () {}, load_transponders_errorFunc);

</script>


<script> // handle events related to the modal "Transponder zurückgeben".

(function () {

  let selected_transponder_id = null;

  const button_modal_transponder_rückgabe = document.getElementById('btn_trans_rückgabe')
  const modal_transponder_rückgabe = document.getElementById('mdl_trans_rückgabe')
  const button_close_transponder_rückgabe = document.getElementById('btn_close_trans_rückgabe')
  const button_transponder_check = document.getElementById('btn_trans_rückgabe_prüfen')

  button_modal_transponder_rückgabe.onclick = function(){
    modal_transponder_rückgabe.style.display = 'block';

    input_element.focus();
  };

  button_close_transponder_rückgabe.onclick = function(){
    modal_transponder_rückgabe.style.display = 'none';

    console.log(selected_transponder_id);

    // return the transponder.
    if (selected_transponder_id) {
      console.log(selected_transponder_id);
      execute_db_query(`

        UPDATE transponder
        SET borrow_time = NULL
        WHERE id = ?

      `, [ selected_transponder_id ]).then(function (result) {
        console.log('test-result:', result);
        // TODO: open a modal that informs the user about the operation being successful.
        load_transponders().then(function () {
          console.log('Transponders reloaded');
        }, load_transponders_errorFunc);
      }, function (reason) {
        console.error('Could not return transponder', reason);
      });
    }

    reset_modal();
    input_element.value = '';
  };

  const input_element = document.querySelector('#input-transponder-number');
  const result_container = document.querySelector('#container-lending-info');
  const room_title = result_container.querySelector('.info-title-room');
  const elements = {
    room: result_container.querySelector('.info-room'),
    lender: result_container.querySelector('.info-lender'),
    lending_time: result_container.querySelector('.info-lending-time'),
    current_time: result_container.querySelector('.info-current-time'),
    on_time: result_container.querySelector('.info-on-time')
  };

  // submit input field on typing
  input_element.addEventListener("keyup", function(event) {
    if (input_element.value.length == 0)
      reset_modal();
    else button_transponder_check.click();
  });

  // load the data of the transponder.
  button_transponder_check.onclick = function(){

    const input = input_element.value;
    if (input.length == 0) return;

    const transponder_id = convert_input_to_transponder_id(input);

    execute_db_query(`

       SELECT transponder.id,
              transponder.borrow_time,
              GROUP_CONCAT(room.name, ', ') as room_name,
              COUNT(room.id) as room_count
         FROM transponder
   INNER JOIN room_transponder ON transponder.id = room_transponder.transponder_id
   INNER JOIN room ON room_transponder.room_id = room.id
        WHERE transponder.id = ?
     GROUP BY transponder.id

    `, [ transponder_id ]).then(function (result) {

      if (!result || result.length == 0)
        return reset_modal();

      transponder = result[0];
      selected_transponder_id = transponder.id;
      console.log(selected_transponder_id, transponder.id);

      if (transponder.room_count > 1)
        room_title.innerText = 'Räume';
      else room_title.innerText = 'Raum';

      elements.room.innerText = transponder.room_name;
      elements.current_time.innerText = format_time(new Date());

      if (transponder.borrow_time) {
        const borrowed_at = new Date(transponder.borrow_time);
        const borrow_date = borrowed_at.toLocaleDateString();
        const borrow_time = format_time(borrowed_at);

        const one_day = 24 * 60 * 60 * 1000;
        const day_difference = Math.round(Math.abs((new Date() - borrowed_at) / one_day))

        let text = borrow_time + ' am ' + borrow_date;
        if (day_difference == 1)
          text = 'Gestern um ' + borrow_time;
        else if (day_difference == 2)
          text = 'Vorgestern um ' + borrow_time;

        elements.lending_time.innerText = text;
        elements.on_time.innerText = day_difference == 1 ? 'Ja' : 'Nein'; // hardcode
        elements.lender.innerText = 'Alex Brimm'; // hardcode
      }
      else {
        elements.lending_time.innerText = '(nicht ausgeliehen)';
        elements.on_time.innerText = '-';
        elements.lender.innerText = '-';
      }

    });

  };

  const convert_input_to_transponder_id = function (input) {
    return parseInt(input.replace(/[\.,]+/g, ''));
  };

  const reset_modal = function () {
    for (key in elements)
      if (elements.hasOwnProperty(key))
        elements[key].innerText = '';
    selected_transponder_id = null;
    room_title.innerText = 'Raum';
  };

  const format_time = function (date) {
    return date.getHours() + ':' + date.getMinutes() + ' Uhr';
  };

})();

</script>
